var roleManager={dtree:null,getroleInfo:function(){$yt_common.pageInfo.config(1,function(pageIndex){var resultData={total:0};$.ajax({url:'tAdmRole/findByPage',type:'POST',async:false,data:{"pageIndexs":pageIndex,"roleNameOrRoleDecal":$(".top-search .search-name").val(),systemId:$yt_common.getSystemId()},success:function(data){resultData=data;$(".commen-table tbody").empty();$.each(resultData.rows,function(i,n){var stateHtml='<span class="enable">启用</span>';if(n.state==0){stateHtml='<span class="disabled">停用</span>'}var tr='<tr><td class="tl"><input  class="roleId" type="hidden" value="'+n.pkId+'"/>'+n.roleName+'</td><td class="tl">'+n.roleDesc+'</td><td>'+stateHtml+'</td>';$(".commen-table tbody").append(tr)})}});return resultData})},getDeptValue:function(obj,id,name,deptType,eleId){if(deptType==2){$('#'+eleId).siblings("input").val(id);$('#'+eleId).hide();$('#'+eleId).siblings(".job-dept-pop-model-button,.dept-pop-model-button").text(name)}else{}},formVaildroleItcode:function(pkId){var result=false;if($(".role-itcode").val()==""){$(".role-itcode").next(".msg-text").text("请输入角色名称")}else if($(".role-itcode").val().length>20){$(".role-itcode").next(".msg-text").text("请不要超过20个字")}else if(_reg.valiLetterEnNumCh($(".role-itcode"))){$(".role-itcode").next(".msg-text").text("请输入正确的格式")}else{$.ajax({cache:false,type:"POST",url:"tAdmRole/checkRoleName",async:false,data:{roleName:$(".role-itcode").val(),pkId:pkId},success:function(data){if(data.roleName!=null){$(".role-itcode").next(".msg-text").text("该角色名称已存在")}else{$(".role-itcode").next(".msg-text").text("");result=true}}})}return result},addroleInfo:function(){var formData=$("#edit-role-info-form").serialize();var otherFormData={systemId:$yt_common.getSystemId(),userItCode:$yt_common.user_info.userItcode};formData=$.addParam(formData,otherFormData);$.ajax({cache:false,type:"POST",url:"tAdmRole/saveBean",async:false,data:formData,success:function(data){$yt_common.prompt(data.msg);if(data.success==0){roleManager.getroleInfo();$("#edit-role-info").hide()}}})},updateroleInfo:function(){var pkId=$(".commen-table tr.active .roleId").val();var formData=$("#edit-role-info-form").serialize();var otherFormData={systemId:$yt_common.getSystemId(),userItCode:$yt_common.user_info.userItcode,pkId:pkId};formData=$.addParam(formData,otherFormData);$.ajax({cache:false,type:"POST",url:"tAdmRole/updateBean",async:false,data:formData,success:function(data){$yt_common.prompt(data.msg);if(data.success==0){roleManager.getroleInfo();$("#edit-role-info").hide()}}})},getUserByRole:function(type){var activeTrs=$(".commen-table tr.active");var ids=activeTrs.find(".roleId").val();$.ajax({cache:false,type:"POST",url:"tAdmRole/getUserByRole",async:true,data:{roleId:ids,userRealName:$(".role-left-list .input-search input").val()},success:function(data){$(".role-left-list ul").empty();if(type==0){$(".role-right-list ul").empty()}$.each(data,function(i,n){var roleElem=$('<li><input type="hidden" value="'+n.id+'"/>'+n.realName+'</li>');if(type==0){if(n.state==0){$(".role-left-list ul").append(roleElem)}else{$(".role-right-list ul").append(roleElem)}}else{if($(".role-right-list input[value='"+n.id+"']").length==0){$(".role-left-list ul").append(roleElem)}}});$(".role-left-list ul li,.role-right-list ul li").on("click",function(){$(this).toggleClass("active")});$(".set-role-button .d-right").on("click",function(){$(".role-right-list ul").append($(".role-left-list ul li"));});$(".set-role-button .d-left").on("click",function(){$(".role-left-list ul").append($(".role-right-list ul li"))});$(".set-role-button .right").on("click",function(){$(".role-right-list ul").append($(".role-left-list ul li.active"))});$(".set-role-button .left").on("click",function(){$(".role-left-list ul").append($(".role-right-list ul li.active"))})}})},getMenuTree:function(){roleManager.dtree=null;roleManager.dtree=new dTree('dtree','roleManager.dtree',$yt_option.websit_path+$yt_option.fileName+'/resources/js/dTree/images/system/dept/');roleManager.dtree.config.check=true;roleManager.dtree.icon.root='resources/images/icons/icon-base.png';roleManager.dtree.icon.node='';var roleId=$(".commen-table tr.active .roleId").val();$.ajax({cache:false,type:"POST",url:"tAdmRole/getSetRoleList",async:false,data:{systemId:$yt_common.getSystemId(),roleId:roleId},success:function(data){dataObj=data;roleManager.dtree.add({id:"MM1",pid:-1,name:'menus',isDisable:1});$.each(dataObj.menuList,function(i,v){roleManager.dtree.add({id:v.id,pid:v.pId,name:v.name,checked:v.checked,isDisable:1})});$.each(dataObj.funcList,function(i,v){roleManager.dtree.add({id:v.id,pid:v.pId,name:v.name,checked:v.checked,isDisable:1})});roleManager.dtree.init(roleManager.dtree)}})},setAdminEvent:function(){$("button.set-user-button").off().on("click",function(){var activeTrs=$(".commen-table tr.active");var roleId=activeTrs.find(".roleId").val();if(activeTrs.length==0){$yt_common.prompt("请选择一行信息进行操作");return false}else{$("#set-admin-model").show();$("#set-admin-model .right-user-data ul").empty();roleManager.getUserInfoByRoleIdByName(roleId)}});$("#set-admin-model .model-search-btn").off().on("click",function(){var activeTrs=$(".commen-table tr.active");var roleId=activeTrs.find(".roleId").val();var userName=$("#set-admin-model .set-admin-inpu").val();roleManager.getUserInfoByRoleIdByName(roleId,userName)});$("#set-admin-model .set-admin-inpu").off().on("keyup",function(){var activeTrs=$(".commen-table tr.active");var roleId=activeTrs.find(".roleId").val();roleManager.getUserInfoByRoleIdByName(roleId,$(this).val())});$("#set-admin-model .set-role-button .d-right").off().on("click",function(){var rootNode=$('#user-tree').tree('getRoot');var childNode=$('#user-tree').tree('getChildren',rootNode.target);var liStr="";$('#user-tree').tree('check',rootNode.target);$("#user-tree").tree('expandAll',rootNode.target);var rightData=$("#set-admin-model .right-user-data ul li .hid-user-Id");var righDataStr=",";$.each(rightData,function(i,d){righDataStr+=$(d).val()+","});$.each(childNode,function(i,n){if(n.attributes.deptType=="3"&&righDataStr.indexOf(","+n.id+",")==-1){liStr='<li><input type="hidden" class="hid-user-Id" value="'+n.id+'"/>'+n.text+'</li>';$("#set-admin-model .right-user-data ul").append(liStr);$("#"+n.domId).find(".tree-title").css("color","#418dcc")}});$("#set-admin-model .right-user-data ul li").on("click",function(){$(this).toggleClass("active")})});$("#set-admin-model .set-role-button .right").off().on("click",function(){var nodes=$('#user-tree').tree('getChecked');var liStr="";var rightData=$("#set-admin-model .right-user-data ul li .hid-user-Id");var righDataStr=",";$.each(rightData,function(i,d){righDataStr+=$(d).val()+","});if(nodes.length>0){for(var i=0;i<nodes.length;i+=1){if(nodes[i].attributes.deptType=="3"&&righDataStr.indexOf(","+nodes[i].id+",")==-1){liStr='<li><input type="hidden" class="hid-user-Id" value="'+nodes[i].id+'"/>'+nodes[i].text+'</li>';$("#set-admin-model .right-user-data ul").append(liStr)}}$("#set-admin-model .right-user-data ul li").on("click",function(){$(this).toggleClass("active")})}});$("#set-admin-model .set-role-button .left").off().on("click",function(){var selDatas=[];$("#set-admin-model .right-user-data ul li.active .hid-user-Id").each(function(i,n){selDatas.push($(n).val())});roleManager.canelCheckedNode(selDatas);$("#set-admin-model .right-user-data ul li.active").remove()});$("#set-admin-model .set-role-button .d-left").off().on("click",function(){var rootNode=$('#user-tree').tree('getRoot');var childNode=$('#user-tree').tree('getChildren',rootNode.target);var liStr="";$("#set-admin-model .right-user-data ul").empty();$('#user-tree').tree('uncheck',rootNode.target);$("#user-tree .tree-title").css("color","#333");$("#set-admin-model .right-user-data ul li").remove()});$("#set-admin-model .confirm").off().on("click",function(){var activeTrs=$(".commen-table tr.active");var roleId=activeTrs.find(".roleId").val();var userIds="";$("#set-admin-model .right-user-data ul li input.hid-user-Id").each(function(i,n){userIds+=$(n).val().substring(1)+","});$.ajax({type:"post",url:"tAdmRole/assignUser",async:true,data:{roleId:roleId,users:userIds},success:function(data){$yt_common.prompt(data.msg);if(data.success==0){$("#set-admin-model .set-admin-inpu").val("");$("#set-admin-model,#pop-modle-alert").hide()}}})});$("#set-admin-model .cancel").on("click",function(){$("#set-admin-model .set-admin-inpu").val("")})},canelCheckedNode:function(selDatas,flag){var rootNode=$('#user-tree').tree('getRoot');var childNode=$('#user-tree').tree('getChildren',rootNode.target);var parentNode="";var parentsNode="";$.each(childNode,function(i,n){$.each(selDatas,function(i,s){if(n.id==selDatas[i]){$("#user-tree").tree("uncheck",n.target);$("#"+n.domId).find("span.tree-title").css("color","#333");if(flag!=undefined&&flag=="all"){parentNode=$("#user-tree").tree('getParent',n.target);parentsNode=$("#user-tree").tree('getParent',parentNode.target);$("#user-tree").tree('collapse',parentNode.target);$("#user-tree").tree('collapse',parentsNode.target)}}})})},getUserInfoByRoleIdByName:function(roleId,selectData){selectData=selectData==undefined?"":selectData;$.ajax({type:"post",url:"tAdmRole/getUserByRole",async:true,data:{roleId:roleId,userRealName:selectData},success:function(data){if(data.success==0){var fileds="id,name,isSelect,deptType";var nodes=ConvertToTreeGridJson(data.obj,"id","parentId",fileds);var testData=eval('('+JSON.stringify(nodes)+')');$("#user-tree").tree({data:testData,animate:true,checkbox:true,onClick:function(node){if(node.checkState!=undefined){if(node.checkState=="checked"){$("#user-tree").tree("uncheck",$("#"+node.domId));$("#"+node.domId).find("span.tree-title").css("color","#333")}else{$("#user-tree").tree("check",$("#"+node.domId));$("#"+node.domId).find("span.tree-title").css("color","#418dcc")}}},onCheck:function(node,checked){if(checked){$("#"+node.domId).find("span.tree-title").css("color","#418dcc");$("#"+node.domId).next().find("li span.tree-title").css("color","#418dcc")}else{$("#"+node.domId).find("span.tree-title").css("color","#333");$("#"+node.domId).next().find("li span.tree-title").css("color","#333")}}});$("#user-tree .tree-node:eq(0)").css("padding-left","10px");var rootNode=$('#user-tree').tree('getRoot');var childNode=$('#user-tree').tree('getChildren',rootNode.target);var liStr="";$.each(childNode,function(i,n){if(n.attributes.deptType=="3"&&n.children==undefined){if($("#set-admin-model .set-admin-inpu").val()!=""){var parentNode=$("#user-tree").tree('getParent',n.target);var parentsNode=$("#user-tree").tree('getParent',parentNode.target);$("#user-tree").tree('expand',parentNode.target);$("#user-tree").tree('expand',parentsNode.target)}}if(n.checkState!=undefined&&n.checkState=="checked"){var parentNode=$("#user-tree").tree('getParent',n.target);var parentsNode=$("#user-tree").tree('getParent',parentNode.target);$("#"+n.domId).find("span.tree-title").css("color","#418dcc");if(n.attributes.deptType=="3"){$("#user-tree").tree('expand',parentNode.target);$("#user-tree").tree('expand',parentsNode.target);var rightData=$("#set-admin-model .right-user-data ul li .hid-user-Id");var righDataStr=",";$.each(rightData,function(i,d){righDataStr+=$(d).val()+","});if(righDataStr.indexOf(","+n.id+",")==-1){liStr='<li><input type="hidden" class="hid-user-Id" value="'+n.id+'"/>'+n.text+'</li>';$("#set-admin-model .right-user-data ul").append(liStr)}}}});$("#set-admin-model .right-user-data ul li").on("click",function(){$(this).toggleClass("active")})}}})}};$(function(){var windowHeight=$(window).height();$(".list-content").css("min-height",windowHeight-200);$("#edit-role-info table tr td input").focus(function(){$(this).next(".msg-text").text("")});roleManager.getroleInfo();roleManager.setAdminEvent();$(".top-search .select-button").click(function(){roleManager.getroleInfo()});$(".top-search .resize-button").click(function(){$(".top-search .search-name").val("");roleManager.getroleInfo()});$("button.add-role-button,button.update-role-button").click(function(){$(".clear-val").val("");$(".clear-html,.msg-text").html("");var activeTrs=$(".commen-table tr.active");var roleId=activeTrs.find(".roleId").val();if($(this).hasClass("add-role-button")){$("#edit-role-info .model-title .title-text").text("新增角色");$(".bottom-btn .confirm").unbind().bind("click",function(){var vaildValue=roleManager.formVaildroleItcode(0);if(vaildValue){roleManager.addroleInfo()}});}else{$("#edit-role-info .model-title .title-text").text("修改角色");if(activeTrs.length==0){$yt_common.prompt("请选择一条信息进行操作");return false}else{var roleDesc=activeTrs.find("td").eq(1).text();var roleName=activeTrs.find("td").eq(0).text();$("#edit-role-info-form textarea[name='roleDesc']").val(roleDesc);$("#edit-role-info-form input[name='roleName']").val(roleName);$(".bottom-btn .confirm").unbind().bind("click",function(){var vaildValue=roleManager.formVaildroleItcode(roleId);if(vaildValue){roleManager.updateroleInfo()}});$(".role-itcode").unbind().bind("blur",function(){roleManager.formVaildroleItcode(roleId)})}}$("#edit-role-info").show()});$(".delete-role-button").click(function(){var activeTrs=$(".commen-table tr.active");if(activeTrs.length==0){$yt_common.prompt("请选择一条信息进行操作")}else{$yt_common.Alert({title:"删除",text:"<div style='line-height: 70px;'>数据删除后无法恢复,请确认?<div>",haveCancelIcon:false,confirmFunction:function(){$.ajax({type:"post",url:"tAdmRole/deleteBeanById",data:{id:$(".commen-table tr.active .roleId").val()},async:false,success:function(data){if(data.success==0){roleManager.getroleInfo()}$yt_common.prompt(data.msg)}})}})}});$(".bottom-btn .cancel").click(function(){$(this).parents(".yt-pop-model").hide()});$(".disable-button").click(function(){var activeTrs=$(".commen-table tr.active");if(activeTrs.length==0){$yt_common.prompt("请选择一条信息进行操作")}else{$.ajax({type:"post",url:"tAdmRole/onUsed",async:true,data:{roleId:$(".commen-table tr.active .roleId").val(),state:0},success:function(data){if(data.success==0){$(".disable-button").hide();$(".enable-button").show();$(".commen-table tr.active .enable,.commen-table tr.active .disabled").removeClass("enable").addClass("disabled").text("停用")}$yt_common.prompt(data.msg)}})}});$(".enable-button").click(function(){var activeTrs=$(".commen-table tr.active");if(activeTrs.length==0){$yt_common.prompt("请选择一条信息进行操作")}else{$.ajax({type:"post",url:"tAdmRole/onUsed",async:true,data:{roleId:$(".commen-table tr.active .roleId").val(),state:1},success:function(data){if(data.success==0){$(".disable-button").show();$(".enable-button").hide();$(".commen-table tr.active .enable,.commen-table tr.active .disabled").addClass("enable").removeClass("disabled").text("启用")}$yt_common.prompt(data.msg)}})}});$("button.set-menu").click(function(){var activeTrs=$(".commen-table tr.active");if(activeTrs.length==0){$yt_common.prompt("请选择一条信息进行操作")}else{$("#set-menu").show();roleManager.getMenuTree();$("#set-menu .confirm").unbind().bind("click",function(){var idsArr=roleManager.dtree.getCheckedNodes();var idsStr='';$.each(idsArr,function(i,n){if(i==0){idsStr=n.id}else{idsStr=idsStr+","+n.id}});$.ajax({type:"post",url:"tAdmRole/addRoleAndMenu",async:false,data:{roleId:activeTrs.find(".roleId").val(),menuFuncIds:idsStr},success:function(data){if(data.success==0){$("#set-menu").hide()}$yt_common.prompt(data.msg)}})})}})});function ConvertToTreeGridJson(rows,idFieldName,pidFieldName,fileds){function exists(rows,ParentId){for(var i=0;i<rows.length;i+=1){if(rows[i][idFieldName]==ParentId){return true}}return false}var nodes=[];for(var i=0;i<rows.length;i+=1){var row=rows[i];if(!exists(rows,row[pidFieldName])){var data={id:row[idFieldName],text:'',"iconCls":'',"attributes":{"deptType":'',"isThisAdmin":""}};var arrFiled=fileds.split(",");for(var j=0;j<arrFiled.length;j+=1){if(arrFiled[j]!=idFieldName){data.text=row[arrFiled[1]]}data.attributes.deptType=row[arrFiled[2]];data.attributes.isThisAdmin=row[arrFiled[3]];data.iconCls='tree-root-def'}if(data!=null){nodes.push(data)}}}console.info("根目录nodes："+JSON.stringify(nodes));var toDo=[];var treeChildObj={id:'',text:'',checked:''};var treeChildStr="id,text,checked";treeChildStr=treeChildStr.split(",");for(var i=0;i<nodes.length;i+=1){toDo.push(nodes[i])}while(toDo.length){var node=toDo.shift();for(var i=0;i<rows.length;i+=1){var row=rows[i];if(row[pidFieldName]==node.id){var child={id:row[idFieldName],text:'',checked:'',"state":'',"attributes":{"deptType":''}};var arrFiled=fileds.split(",");for(var j=0;j<arrFiled.length;j+=1){if(arrFiled[j]!=idFieldName){child.text=row[arrFiled[1]];child.checked=(row[arrFiled[2]]=="1"?true:false);child.attributes.deptType=row[arrFiled[3]];if(row[arrFiled[3]]=="1"){child.state="closed"}}}if(node.children){node.children.push(child)}else{node.children=[child]}toDo.push(child)}}}return nodes};