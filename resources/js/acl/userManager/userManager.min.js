var userManager={dtree:null,defualtEmail:"",leftTreeData:'',getUserInfo:function(deptId,deptType){$yt_common.pageInfo.config(1,function(pageIndex){$(".top-button button.set-user-name").hide();var resultData={total:0};if(userManager.leftTreeData!=""){if(deptId==''||deptType==''){var rootNode=$('#dept-tree').tree('getRoot');if(rootNode!=""&&rootNode!=null){deptId=rootNode.id;deptType=rootNode.attributes.deptType}}}var data=$.param({"pageIndexs":pageIndex,"userNameOrRealName":$(".top-search .search-name").val(),"deptType":deptType,"deptId":deptId});$.ajax({url:'tAdmUser/findByPage',type:'POST',async:false,data:data,success:function(data){resultData=data;$(".commen-table tbody").empty();if(resultData.rows.length>0){$.each(resultData.rows,function(i,n){var stateHtml='<span class="enable">启用</span>';if(n.disabled==0){stateHtml='<span class="disabled">停用</span>'}var tr='<tr><td><input  class="userId" type="hidden" value="'+n.pkId+'"/><span class="user-code">'+n.userItcode+'</span></td><td style="width: 50px;">'+n.userName+'</td><td class="tl">'+n.compNaming+'</td><td class="tl">'+n.deptNaming+'</td><td class="tl">'+n.posiNaming+'</td><td class="tl">'+n.userEmail+'</td><td>'+stateHtml+'</td></tr>';$(".commen-table tbody").append(tr)});$(".user-info-list .page-info.opinion-page").show()}else{$(".user-info-list .page-info.opinion-page").hide();var noStr='<tr style="background:#fff !important;"><td align="center" colspan="7" style="padding:40px;"><div style="margin-bottom:25px;"><img src="./resources/images/icons/no-data.png"/></div><div style="color:#999;font-size:20px;">暂时没有数据~</div></td></tr>';$(".commen-table tbody").append(noStr)}userManager.tableTrClickEvent()}});return resultData})},getNewDeptTree:function(){$.ajax({type:"post",url:"tAdmDept/getDeptByParam",data:{systemId:$("#yt-index-head-sys select").val()},async:false,success:function(data){var urlFlag="";dataObj=data;userManager.leftTreeData=data;var fileds="id,forShort,deptType,isThisAdmin";if(dataObj!=""&&dataObj.length>0){var nodes=ConvertToTreeGridJson(dataObj,"pkId","parentId",fileds);var testData=eval('('+JSON.stringify(nodes)+')');if(testData!=""&&testData!=null&&testData.length>0){$("#dept-tree").tree({data:testData,animate:true,onClick:function(node){userManager.getUserInfo(node.id,node.attributes.deptType);userManager.tableTrClickEvent();$(".top-button button.set-user-name").hide();},onBeforeExpand:function(node){if(node.iconCls=="tree-folder-close-disable"){$("#"+node.domId).find("span.tree-icon").removeClass("tree-folder-close-disable");$("#"+node.domId).find("span.tree-icon").addClass("tree-folder-disable-open")}},onBeforeCollapse:function(node){if(node.iconCls=="tree-folder-close-disable"){$("#"+node.domId).find("span.tree-icon").removeClass("tree-folder-disable-open");$("#"+node.domId).find("span.tree-icon").addClass("tree-folder-close-disable")}}});var rootNode=$('#dept-tree').tree('getRoot');var childNode=$('#dept-tree').tree('getChildren',rootNode.target);$.each(childNode,function(i,n){if(n.children){$("#"+n.domId).find("span.tree-icon").removeClass("tree-folder-child")}})}}else{var noStr='<tr style="background:#fff !important;"><td align="center" colspan="7" style="padding:40px;"><div style="margin-bottom:25px;"><img src="./resources/images/icons/no-data.png"/></div><div style="color:#999;font-size:20px;">暂时没有数据~</div></td></tr>';$(".commen-table tbody").append(noStr)}}})},getDeptTree:function(eleId){$("#edit-user-info .dtree").remove();userManager.dtree=null;userManager.dtree=new dTree(eleId,'userManager.dtree',$yt_option.websit_path+'/resources/js/dTree/images/system/dept/');if($yt_common.dept_info_data==null){$.ajax({cache:false,type:"POST",url:"tAdmDept/getDeptByParam",async:false,success:function(data){dataObj=data;$yt_common.dept_info_data=data;$.each(dataObj,function(i,v){var pId="";if(v.parentId==0){pId="-1"}else{pId=v.parentId}if(v.isThisAdmin=="1"){urlFlag='javascript:userManager.getDeptValue(this,'+v.compId+','+v.id+',\''+v.forShort+'\','+v.deptType+',\''+eleId+'\')'}else{urlFlag=""}var name=v.forShort;userManager.dtree.add({id:v.pkId,pid:pId,name:'<span class="'+(v.isThisAdmin=="2"?'tree-disable-font':'')+'"style="'+(v.deptType==2?"font-size:12px;":'')+'">'+name+'</span>',isDisable:v.isThisAdmin,url:urlFlag})});userManager.dtree.init(userManager.dtree);userManager.dtree.openTo($(".dept-hinput").val(),true,false)}})}else{dataObj=$yt_common.dept_info_data;$.each(dataObj,function(i,v){var pId="";if(v.parentId==0){pId="-1"}else{pId=v.parentId}if(v.isThisAdmin=="1"){urlFlag='javascript:userManager.getDeptValue(this,'+v.compId+','+v.id+',\''+v.forShort+'\','+v.deptType+',\''+eleId+'\')'}else{urlFlag=""}var name=v.forShort;userManager.dtree.add({id:v.pkId,pid:pId,name:'<span class="'+(v.isThisAdmin=="2"?'tree-disable-font':'')+'"style="'+(v.deptType==2?"font-size:12px;":'')+'">'+name+'</span>',isDisable:v.isThisAdmin,url:urlFlag})});userManager.dtree.init(userManager.dtree);userManager.dtree.openTo($(".dept-hinput").val(),true,false)}},getDeptValue:function(obj,compId,id,name,deptType,eleId){if(deptType==2){$('#'+eleId).siblings("input").val(id);$('#'+eleId).siblings("input").attr("compId",compId);$('#'+eleId).hide();$('#'+eleId).parent().removeClass("active");$('#'+eleId).siblings(".job-dept-pop-model-button,.dept-pop-model-button").text(name);$('#'+eleId).parent().next(".msg-text").text("")}var thisObj=$('#'+eleId).siblings(".job-dept-pop-model-button,.dept-pop-model-button").parent().parent().parent();userManager.getGroupList(thisObj.next().find(".group-pop-model-button"));$('#'+eleId).parent().next(".msg-text").text("")},getGroupList:function(obj){var deptId=$(obj).parent().parent().parent().prev().find("input[type='hidden']").attr("compId");var ulElement=$(obj).siblings(".group-pop-model,.job-group-pop-model").find("ul");var posiName=$(obj).siblings(".group-pop-model,.job-group-pop-model").find(".group-search").val();$.ajax({cache:false,type:"POST",url:"tAdmDept/getUserPosition",data:{deptId:deptId,posiName:posiName},async:false,success:function(data){ulElement.empty();$.each(data,function(i,n){var groupEle=$('<li>'+n.posiName+'</li>');ulElement.append(groupEle);groupEle.click(function(){$(obj).siblings("input").val(n.posiCode);$(obj).text(n.posiName);$(obj).siblings(".group-pop-model,.job-group-pop-model").hide();$(obj).parent().removeClass("active");groupEle.parents(".group-manager.select-button").next(".msg-text").text("")})})}})},formVaildUserItcode:function(){var result=false;if($(".user-itcode").val()==""){$(".user-itcode").next(".msg-text").text("请输入用户名")}else if($(".user-itcode").val().length>20){$(".user-itcode").next(".msg-text").text("请不要超过20个字")}else if(_reg.valiLetterEnNum($(".user-itcode"))){$(".user-itcode").next(".msg-text").text("请输入正确的格式")}else{$.ajax({cache:false,type:"POST",url:"tAdmUser/isHaveItcote",async:false,data:{itcode:$(".user-itcode").val()},success:function(data){if(data>0){$(".user-itcode").next(".msg-text").text("该用户名已存在")}else{$(".user-itcode").next(".msg-text").text("");$(".user-email").text($(".user-itcode").val()+userManager.defualtEmail);result=true}}})}return result},formVaidUserName:function(){var result=false;if($(".user-real-name").val()==""){$(".user-real-name").next(".msg-text").text("请输入姓名")}else if(_reg.valiLetterEnNumCh($(".user-real-name"))){$(".user-real-name").next(".msg-text").text("请输入正确的格式")}else if($(".user-real-name").val().length>30){$(".user-real-name").next(".msg-text").text("请不要超过30个字")}else{$(".user-real-name").next(".msg-text").text("");result=true}return result},formVaidPhone:function(){var result=false;if($(".user-phone").val()==""){$(".user-phone").next(".msg-text").text("请输入手机号")}else if(_reg.valiCellPhone($(".user-phone"))){$(".user-phone").next(".msg-text").text("请输入正确的手机号格式")}else{$(".user-phone").next(".msg-text").text("");result=true}return result},formVaidDept:function(){var result=false;if($(".dept-hinput").val()==""){$(".dept-hinput").parent().next(".msg-text").text("请选择部门")}else{$(".dept-hinput").parent().next(".msg-text").text("");result=true}return result},formVaidGroup:function(){var result=false;if($(".group-hinput:eq(0)").val()==""){$(".group-hinput:eq(0)").parent().next(".msg-text").text("请选择职位")}else{$(".group-hinput:eq(0)").parent().next(".msg-text").text("");result=true}return result},vaidJobInfo:function(){var result=true;if($(".job-list-dept").length>0){if($(".job-list-dept:last() .job-dept-hinput").val()==""){$(".job-list-dept:last() .msg-text").text("请选择兼职部门");result=false}else{$(".job-list-dept:last() .msg-text").text("")}if($(".job-list-group:last() .job-group-hinput").val()==""){$(".job-list-group:last() .msg-text").text("请选择兼职职位");result=false}else{$(".job-list-group:last() .msg-text").text("")}}return result},addUserInfo:function(){var formData=$("#edit-user-info-form").serialize();var userEmail=$(".user-email").text();var addIdDept=$(".dept-hinput").val();var addIdPosi=$(".group-hinput").val();var mainPosiList='{"deptId":"'+addIdDept+'","posiCode":"'+addIdPosi+'"}';var otherPosiList=this.getJobInfo();var otherFormData={userEmail:userEmail,mainPosiList:mainPosiList,createTimeBy:$yt_common.user_info.pkId,updateTimeBy:$yt_common.user_info.pkId,otherPosiList:otherPosiList,systemId:$yt_common.getSystemId()};formData=formData+"&"+$.param(otherFormData);$.ajax({cache:false,type:"POST",url:"tAdmUser/saveBean",async:false,data:formData,success:function(data){if(data.success==0){$yt_common.prompt(data.msg);$("#edit-user-info").hide();setTimeout(function(){var deptId="";var deptType="";var treeSelNode=$("#dept-tree").tree('getSelected');if(treeSelNode!=null&&treeSelNode!=""){deptId=treeSelNode.id;deptType=treeSelNode.attributes.deptType}else{var rootNode=$('#dept-tree').tree('getRoot');if(rootNode!=""&&rootNode!=null){deptId=rootNode.id;deptType=rootNode.attributes.deptType}}userManager.getUserInfo(deptId,deptType)},10)}}})},getJobInfo:function(){var jobDetpEles=$(".job-list-dept");var jobGroupEles=$(".job-list-group");var jobDatas=[];$.each(jobDetpEles,function(i,n){var deptId=$(n).find("input[name='deptId']").val();var posiCode=$(jobGroupEles[i]).find("input[name='posiCode']").val();var jobData={deptId:deptId,posiCode:posiCode};jobDatas.push(jobData)});var otherPosiList=JSON.stringify(jobDatas);return otherPosiList},updateUserInfo:function(){var pkId=$(".commen-table tr.active .userId").val();var formData=$("#edit-user-info-form").serialize();var userEmail=$(".user-email").text();var addIdDept=$(".dept-hinput").val();var addIdPosi=$(".group-hinput").val();var mainPosiList='{"deptId":"'+addIdDept+'","posiCode":"'+addIdPosi+'"}';var otherPosiList=this.getJobInfo();var otherFormData={userEmail:userEmail,mainPosiList:mainPosiList,pkId:pkId,createTimeBy:$yt_common.user_info.pkId,updateTimeBy:$yt_common.user_info.pkId,otherPosiList:otherPosiList};formData=formData+"&"+$.param(otherFormData);$.ajax({cache:false,type:"POST",url:"tAdmUser/updateBean",async:false,data:formData,success:function(data){if(data.success==0){$yt_common.prompt(data.msg);$("#edit-user-info").hide();setTimeout(function(){var deptId="";var deptType="";var treeSelNode=$("#dept-tree").tree('getSelected');if(treeSelNode!=null&&treeSelNode!=""){deptId=treeSelNode.id;deptType=treeSelNode.attributes.deptType}else{var rootNode=$('#dept-tree').tree('getRoot');if(rootNode!=""&&rootNode!=null){deptId=rootNode.id;deptType=rootNode.attributes.deptType}}userManager.getUserInfo(deptId,deptType)},10)}}})},addJobEle:function(job){var deptId="";var deptName="点击选择部门";var posiCode="";var posiName='点击选择职位';if(job){deptId=job.deptId;deptName=job.deptName;posiCode=job.posiCode;posiName=job.posiName}var modelLenth=$(".job-list-dept").length;var modelId="showTreearea"+modelLenth;var jobEle=$('<tr class="job-list-dept"><td><div class="form-label">部门：</div></td><td><div class="input-button job-dept-manager select-button" style="position: relative;"><input type="hidden" class="job-dept-hinput" value="'+deptId+'" name="deptId" /><div class="job-dept-pop-model-button show_hide_div">'+deptName+'</div><div class="job-dept-pop-model hide_div" id="'+modelId+'" ></div><span class="job-dept-pop-modul-remove">删除</span></div><div class="msg-text" ></div></td></tr><tr class="job-list-group"><td><div class="form-label">职位：</div></td><td><div class="input-button group-manager select-button"><input type="hidden" class="job-group-hinput" value="'+posiCode+'" name="posiCode" /><div class="job-group-pop-model-button show_hide_div">'+posiName+'</div><div class="job-group-pop-model hide_div" ><input type="text" class="group-search" value="" /><ul></ul></div></div><div class="msg-text" ></div></td></tr>');$(".job-list-bottom").before(jobEle);jobEle.find(".job-dept-pop-model-button").click(function(){$("#"+modelId).show();$("#"+modelId).parent().addClass("active");userManager.getDeptTree(modelId)});jobEle.find(".group-search").keyup(function(){userManager.getGroupList(jobEle.find(".job-group-pop-model-button"))});jobEle.find(".job-group-pop-model-button").click(function(){if($("input.job-dept-hinput").val()==""){$yt_common.prompt("请先选择部门");return false}userManager.getGroupList(jobEle.find(".job-group-pop-model-button"));$(this).siblings(".job-group-pop-model").show();$(this).parent().addClass("active")});jobEle.find(".job-dept-pop-modul-remove").click(function(){jobEle.remove();var h=$("#edit-user-info").children("div").height();var w=$(window).height();var hh=w-90;if((h-68)>w){h=w-50;$("#edit-user-info>div>div").not(".model-title").css("height",hh)}var r=(w-h)/2;$("#edit-user-info").css({"top":r,"bottom":r})});var h=$("#edit-user-info").children("div").height();var w=$(window).height();var hh=w-90;if((h-68)>w){h=w-50;$("#edit-user-info>div>div").not(".model-title").css("height",hh)}var r=(w-h)/2;$("#edit-user-info").css({"top":r,"bottom":r})},getBaseInfo:function(){if($yt_common.baseInfo==""){$yt_common.prompt("还没有邮箱后缀,请配置基础信息");return false}userManager.defualtEmail=$yt_common.baseInfo.userDefaultEmail},tableTrClickEvent:function(){$(".list-content table.commen-table tbody tr td").click(function(){if($(this).parent().find("td:eq(0) .user-code").text()==""){$(".top-button button.set-user-name").show()}else{$(".top-button button.set-user-name").hide()}})}};$(function(){var windowHeight=$(window).height();$(".list-content").css("min-height",windowHeight-200);$("#edit-user-info table tr td input").focus(function(){$(this).next(".msg-text").text("")});userManager.getNewDeptTree();var deptId="";var deptType="";if(userManager.leftTreeData!=""&&userManager.leftTreeData!=null){var rootNode=$('#dept-tree').tree('getRoot');if(rootNode!=""&&rootNode!=null){deptId=rootNode.id;deptType=rootNode.attributes.deptType}}userManager.getUserInfo(deptId,deptType);userManager.getBaseInfo();userManager.tableTrClickEvent();$(".top-button button.set-user-name").off().on("click",function(){var activeTrs=$(".commen-table tr.active");$("#set-username-model").show();$("#set-username-model .user-name-span").text(activeTrs.find("td:eq(1)").text());$("#set-username-model button.confirm").off().on("click",function(){var result=false;var userName=$("input.set-user-name-inpu").val();if(userName!=""&&userName.length>30){$("input.set-user-name-inpu").next(".msg-text").text("请不要超过30个字")}else if(_reg.valiLetterEnNumCh($("input.set-user-name-inpu"))){$("input.set-user-name-inpu").next(".msg-text").text("请输入正确格式")}else{$("input.set-user-name-inpu").next(".msg-text").text("");result=true}if(result){$.ajax({cache:false,type:"POST",url:"tAdmUser/updateUserNameByUserId",async:false,data:{id:activeTrs.find(".userId").val(),userName:userName},success:function(data){if(data.success==0){$yt_common.prompt(data.msg);$("#set-username-model").hide();setTimeout(function(){var deptId="";var deptType="";var treeSelNode=$("#dept-tree").tree('getSelected');if(treeSelNode!=null){deptId=treeSelNode.id;deptType=treeSelNode.attributes.deptType}else{var rootNode=$('#dept-tree').tree('getRoot');if(rootNode!=""&&rootNode!=null){deptId=rootNode.id;deptType=rootNode.attributes.deptType}}userManager.getUserInfo(deptId,deptType)},10)}else{$yt_common.prompt(data.msg)}}})}});$("#set-username-model button.cancel").off().on("click",function(){$("input.set-user-name-inpu").val("");$("#set-username-model,#pop-modle-alert").hide()})});$(".top-search .select-button").click(function(){var deptId="";var deptType="";var treeSelNode=$("#dept-tree").tree('getSelected');if(treeSelNode!=null){deptId=treeSelNode.id;deptType=treeSelNode.attributes.deptType}userManager.getUserInfo(deptId,deptType)});$(".top-search .resize-button").click(function(){$(".top-search .search-name").val("");var treeSelNode=$("#dept-tree").tree('getSelected');if(treeSelNode!=null){deptId=treeSelNode.id;deptType=treeSelNode.attributes.deptType}userManager.getUserInfo(deptId,deptType)});$("button.add-user-button,button.update-user-button").click(function(){$(".clear-val").val("");$(".clear-html,.msg-text").html("");$(".dept-pop-model-button").html("点击选择部门");$(".group-pop-model-button").html("点击选择职位");$(".job-list-dept,.job-list-group").remove();if($(this).hasClass("add-user-button")){$("#edit-user-info .model-title .title-text").text("新增人员信息");$("#edit-user-info .bottom-btn .confirm").unbind().bind("click",function(){userManager.formVaildUserItcode();userManager.formVaidUserName();userManager.formVaidPhone();userManager.formVaidDept();userManager.formVaidGroup();userManager.vaidJobInfo();var vaildValue=userManager.formVaildUserItcode()&&userManager.formVaidUserName()&&userManager.formVaidPhone()&&userManager.formVaidDept()&&userManager.formVaidGroup()&&userManager.vaidJobInfo();if(vaildValue){userManager.addUserInfo()}});$(".user-itcode").replaceWith('<input type="text" class="input user-itcode clear-val" name="userItcode" />');$(".user-itcode").focus(function(){$(this).next(".msg-text").text("")})}else{$("#edit-user-info .model-title .title-text").text("修改人员信息");var activeTrs=$(".commen-table tr.active");if(activeTrs.length==0){$yt_common.prompt("请选择一条信息进行操作");return false}else{$.ajax({cache:false,type:"POST",url:"tAdmUser/getBeanById",async:false,data:{id:activeTrs.find(".userId").val()},success:function(data){$(".user-itcode").replaceWith('<div class="user-itcode clear-html" style="line-height: 36px;height: 36px;">'+data.userItcode+'</div>');$("#edit-user-info-form input[name='userName']").val(data.userName);$("#edit-user-info-form input[name='userPhone']").val(data.userPhone);$("#edit-user-info-form .user-email").text(data.userEmail)}});$.ajax({cache:false,type:"POST",url:"tAdmUser/getUserDeptAndPosi",async:false,data:{userId:activeTrs.find(".userId").val()},success:function(data){$.each(data,function(i,n){if(n.types=='MAIN_JOB'){$("#edit-user-info-form .dept-pop-model-button").text(n.deptName);$("#edit-user-info-form .dept-hinput").val(n.deptId);$("#edit-user-info-form .group-pop-model-button").text(n.posiName);$("#edit-user-info-form .group-hinput").val(n.posiCode)}else if(n.types="PART_TIME"){userManager.addJobEle(n)}})}});$("#edit-user-info .bottom-btn .confirm").unbind().bind("click",function(){userManager.formVaidUserName();userManager.formVaidPhone();userManager.formVaidDept();userManager.formVaidGroup();userManager.vaidJobInfo();var vaildValue=userManager.formVaidUserName()&&userManager.formVaidPhone()&&userManager.formVaidDept()&&userManager.formVaidGroup()&&userManager.vaidJobInfo();if(vaildValue){userManager.updateUserInfo()}})}}$("#edit-user-info").show()});$(".set-user-button").click(function(){var activeTrs=$(".commen-table tr.active");var ids=activeTrs.find(".userId").val();if(activeTrs.length==0){$yt_common.prompt("请选择一条信息进行操作")}else{$("#set-user-role").show();$.ajax({cache:false,type:"POST",url:"tAdmUser/getRoleByUser",async:false,data:{userId:ids,systemId:$("#yt-index-head-sys select").val()},success:function(data){$(".role-left-list ul").empty();$(".role-right-list ul").empty();$.each(data,function(i,n){var roleElem=$('<li><input type="hidden" value="'+n.id+'"/>'+n.name+'</li>');if(n.state==0){$(".role-left-list ul").append(roleElem)}else{$(".role-right-list ul").append(roleElem)}})}});$(".role-left-list ul li,.role-right-list ul li").on("click",function(){$(this).toggleClass("active")});$(".set-role-button .d-right").on("click",function(){$(".role-right-list ul").append($(".role-left-list ul li"));});$(".set-role-button .d-left").on("click",function(){$(".role-left-list ul").append($(".role-right-list ul li"))});$(".set-role-button .right").on("click",function(){$(".role-right-list ul").append($(".role-left-list ul li.active"))});$(".set-role-button .left").on("click",function(){$(".role-left-list ul").append($(".role-right-list ul li.active"))})}$(".set-user-role .confirm").click(function(){var selectRole=$(".role-right-list ul li");var roleOrGroups="";$.each(selectRole,function(i,n){if(i>0){roleOrGroups=roleOrGroups+","+$(n).find("input").val()}else{roleOrGroups=$(n).find("input").val()}});$.ajax({cache:false,type:"POST",url:"tAdmUser/addRoleByUser",async:false,data:{ids:ids,roleOrGroups:roleOrGroups,systemId:$("#yt-index-head-sys select").val()},success:function(data){if(data.success==0){$yt_common.prompt(data.msg);$("#set-user-role").hide()}}})})});$(".delete-user-button").click(function(){var activeTrs=$(".commen-table tr.active");if(activeTrs.length==0){$yt_common.prompt("请选择一条信息进行操作")}else{$yt_common.Alert({title:"删除",text:"<div style='line-height: 70px;'>数据删除后无法恢复,请确认?<div>",haveCancelIcon:false,confirmFunction:function(){$.ajax({type:"post",url:"tAdmUser/deleteBeanById",data:{id:$(".commen-table tr.active .userId").val()},async:false,success:function(data){if(data.success==0){var deptId="";var deptType="";var treeSelNode=$("#dept-tree").tree('getSelected');if(treeSelNode!=null){deptId=treeSelNode.id;deptType=treeSelNode.attributes.deptType}else{var rootNode=$('#dept-tree').tree('getRoot');if(rootNode!=""&&rootNode!=null){deptId=rootNode.id;deptType=rootNode.attributes.deptType}}userManager.getUserInfo(deptId,deptType)}$yt_common.prompt(data.msg)}})}})}});$(".update-pwd-button").click(function(){var activeTrs=$(".commen-table tr.active");if(activeTrs.length==0){$yt_common.prompt("请选择一条信息进行操作")}else{$("#resite-pwd,#q-alert-bg").show();$("#resite-pwd .alert-right-button").click(function(){$("#resite-pwd,#q-alert-bg").hide()});$("#resite-pwd .alert-left-button").click(function(){$.ajax({type:"post",url:"tAdmUser/updatePassword",async:true,data:{pkId:activeTrs.find(".userId").val(),systemId:$("#yt-index-head-sys select").val()},success:function(data){if(data.success==0){$("#resite-pwd").hide();$("#resite-pwd,#q-alert-bg").hide()}$yt_common.prompt(data.msg)}})})}});$('.dept-pop-model-button').click(function(){$(this).next(".dept-pop-model").show();$(this).parent().addClass("active");userManager.getDeptTree("showTreearea")});$(".group-pop-model-button").click(function(){if($("input.dept-hinput").val()==""){$yt_common.prompt("请先选择部门");return false}$(this).next(".group-pop-model").show();$(this).parent().addClass("active");userManager.getGroupList($(".group-pop-model-button"))});$(".group-search").keyup(function(){userManager.getGroupList($(".group-pop-model-button"))});$(".bottom-btn .cancel").click(function(){$(this).parents(".yt-pop-model").hide()});$(".disable-button").click(function(){var activeTrs=$(".commen-table tr.active");if(activeTrs.length==0){$yt_common.prompt("请选择一条信息进行操作")}else{$.ajax({type:"post",url:"tAdmUser/outUsed",async:true,data:{userId:$(".commen-table tr.active .userId").val()},success:function(data){if(data.success==0){$(".disable-button").hide();$(".enable-button").show();$(".commen-table tr.active .enable,.commen-table tr.active .disabled").removeClass("enable").addClass("disabled").text("停用")}$yt_common.prompt(data.msg)}})}});$(".enable-button").click(function(){var activeTrs=$(".commen-table tr.active");if(activeTrs.length==0){$yt_common.prompt("请选择一条信息进行操作")}else{$.ajax({type:"post",url:"tAdmUser/onUsed",async:true,data:{userId:$(".commen-table tr.active .userId").val()},success:function(data){if(data.success==0){$(".disable-button").show();$(".enable-button").hide();$(".commen-table tr.active .enable,.commen-table tr.active .disabled").addClass("enable").removeClass("disabled").text("启用")}$yt_common.prompt(data.msg)}})}});$("body").delegate("#file","change",function(e){var file=$("#file").val();var strFileName=file.replace(/^.+?\\([^\\]+?)(\.[^\.\\]*?)?$/gi,"$1");if(strFileName==""){$("#file").val("");$("#import-pop-file-button").text("点击上传文件")}else{var FileExt=file.replace(/.+\./,"");var showName=strFileName;if(strFileName.indexOf(FileExt)==-1){showName=strFileName+"."+FileExt}$(this).next("div").text(showName);$(this).attr("title",showName)}});$("#import-pop-file-button").click(function(){$(this).siblings("input[type='file']").click()});$(".import-button").click(function(){$("#import-pop,#q-alert-bg").show();$("#import-pop .import-cancel-button").click(function(){$("#import-pop,#q-alert-bg").hide()});$("#import-pop .download-button").unbind().bind("click",function(){var downloadUrl=$yt_option.base_path+"tAdmUser/download?yitianSSODynamicKey="+$yt_common.getToken();$yt_common.ajax_download_file(downloadUrl)});$("#import-pop .import-confirm-button").unbind().bind("click",function(){var param={yitianSSODynamicKey:$yt_common.getToken(),systemId:$("#yt-index-head-sys select").val(),createTimeBy:$yt_common.user_info.pkId};var url=$yt_option.base_path+"tAdmUser/upload?"+$.param(param);if($("input.file-button").val()==""){$yt_common.prompt("请选择文件");return false}$.ajaxFileUpload({url:url,type:"post",dataType:'json',fileElementId:'file',success:function(data,textStatus){var msg=jQuery.parseJSON(data).obj;if(msg!=null&&msg!=""){$("#import-detail .into-num").text(msg.all);$("#import-detail .add-info-num").text(msg.add);$("#import-detail .update-info-num").text(msg.update);$("#import-detail .erro-info-num").text(msg.errCount);$("#import-detail .import-info-list tbody").empty();var trStr="";if(msg.errCount>0){if(msg.errData!=""&&msg.errData.length>0){$.each(msg.errData,function(i,n){trStr='<tr><td align="center"><div style="width:34px">'+(i+1)+'</div></td><td align="center"><div style="width:116px;">'+n.userItcode+'</div></td><td align="center"><div  style="width:116px;">'+n.userName+'</div></td><td class="pad"><div style="width:131px">'+n.compNaming+'</div></td><td class="pad"><div style="width:106px">'+n.deptName+'</div></td><td class="pad"><div style="width:106px">'+n.posiName+'</div></td><td class="pad"><div style="width:160px">'+n.errMsg+'</div></td></tr>';$("#import-detail .import-info-list tbody").append(trStr)})}}}$("#import-detail").show();if(jQuery.parseJSON(data).success==0){var deptId="";var deptType="";var treeSelNode=$("#dept-tree").tree('getSelected');if(treeSelNode!=null&&treeSelNode!=""){deptId=treeSelNode.id;deptType=treeSelNode.attributes.deptType}userManager.getUserInfo(deptId,deptType);$("#import-pop,#q-alert-bg").hide();$("#file").val("");$("#import-pop-file-button").text("点击上传文件")}else{$("#import-pop,#q-alert-bg").hide();$("#import-detail .error-data,#import-detail .import-info-list,.hid-thead").show()}getDivPosition($(".import-detail-model .model-midd-cont"))},error:function(data,status,e){$yt_common.prompt("文件上传失败")}});$(".import-detail-model button.close-btn").click(function(){$(".import-detail-model,#q-alert-bg").hide();$("#file").attr("title","");$("#import-pop-file-button").text("点击上传文件")})})});$(".add-job").click(function(){if(userManager.vaidJobInfo()){userManager.addJobEle()}})});function ConvertToTreeGridJson(rows,idFieldName,pidFieldName,fileds){function exists(rows,ParentId){for(var i=0;i<rows.length;i+=1){if(rows[i][idFieldName]==ParentId){return true}}return false}var nodes=[];for(var i=0;i<rows.length;i+=1){var row=rows[i];if(!exists(rows,row[pidFieldName])){var data={id:row[idFieldName],text:'',"iconCls":'',"attributes":{"deptType":'',"isThisAdmin":""}};var arrFiled=fileds.split(",");for(var j=0;j<arrFiled.length;j+=1){if(arrFiled[j]!=idFieldName){data.text=row[arrFiled[1]]}data.attributes.deptType=row[arrFiled[2]];data.attributes.isThisAdmin=row[arrFiled[3]];data.iconCls='tree-root-def'}if(data!=null){nodes.push(data)}}}console.info("根目录nodes："+JSON.stringify(nodes));var toDo=[];var treeChildObj={id:'',text:''};var treeChildStr="id,text";treeChildStr=treeChildStr.split(",");for(var i=0;i<nodes.length;i+=1){toDo.push(nodes[i])}while(toDo.length){var node=toDo.shift();for(var i=0;i<rows.length;i+=1){var row=rows[i];if(row[pidFieldName]==node.id){var child={id:row[idFieldName],text:'',"state":'',"iconCls":'',"attributes":{"deptType":'',"isThisAdmin":""}};var arrFiled=fileds.split(",");for(var j=0;j<arrFiled.length;j+=1){if(arrFiled[j]!=idFieldName){child.text=row[arrFiled[1]];child.attributes.deptType=row[arrFiled[2]];child.attributes.isThisAdmin=row[arrFiled[3]];if(row[arrFiled[2]]=="1"){child.state="closed";}else{child.iconCls='tree-folder-child';}}}if(node.children){node.children.push(child)}else{node.children=[child]}toDo.push(child)}}}return nodes};function getDivPosition(obj){var scrollTop="";var scrollLeft="";var q_alert_top="";var q_alert_left=($(window).width()-$(obj).width())/2;q_alert_top=($(window).height()-$(obj).height()+100)/2-80;if(q_alert_left>0){$(obj).parent().css("left",q_alert_left+"px")}else{$(obj).parent().css("left","0")}if(q_alert_top>0){$(obj).parent().css("top",q_alert_top+"px")}else{$(obj).parent().css("top","0px")}}$(window).scroll(function(){if($("body").find(".user-hid-theard").length>0){$(".user-hid-theard").css("top",$(window).scrollTop()+195)}});